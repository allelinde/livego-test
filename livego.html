<!doctype html>
<html lang="sv">
<head>
<meta charset="utf-8">
<title>Livego IPTV</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
  :root {
    --bg-main: #191919;
    --bg-panel: #252525;
    --bg-panel-alt: #2b2b2f;
    --bg-sidebar: #202024;
    --bg-list: #26262a;
    --bg-list-alt: #2b2b30;
    --accent: #ff9f1c;
    --accent-soft: rgba(255,159,28,0.14);
    --accent-strong: rgba(255,159,28,0.25);
    --accent-border: rgba(255,159,28,0.55);
    --accent-glow: 0 0 10px rgba(255,159,28,0.45);
    --text-main: #f5f5f5;
    --text-muted: #a0a0a0;
    --border-subtle: #2f2f33;
    --border-strong: #3b3b40;
    --shadow-soft: 0 18px 50px rgba(0,0,0,0.65);
    --shadow-card: 0 10px 30px rgba(0,0,0,0.7);
    --card-radius: 22px;
    --chip-radius: 999px;
    --backdrop-blur: blur(18px);
    --danger: #ff4757;
    --danger-soft: rgba(255,71,87,0.16);
    --danger-border: rgba(255,71,87,0.45);
    --success: #2ed573;
    --success-soft: rgba(46,213,115,0.18);
    --success-border: rgba(46,213,115,0.55);
    --scrollbar-track: #18181c;
    --scrollbar-thumb: #3b3b44;
    --scrollbar-thumb-hover: #50505a;
  }

  * { box-sizing: border-box; }

  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background: radial-gradient(circle at top, #272727 0, #141414 45%, #050505 100%);
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
    color: var(--text-main);
    overflow: hidden;
  }

  body {
    display: flex;
    justify-content: center;
    align-items: stretch;
  }

  .app-root {
    position: relative;
    width: 100%;
    max-width: 1440px;
    height: 100vh;
    margin: 0 auto;
    padding: 18px;
    display: flex;
    justify-content: center;
    align-items: stretch;
    gap: 18px;
  }

  .app-root::before {
    content: "";
    position: fixed;
    inset: 0;
    background:
      radial-gradient(circle at top left, rgba(255,159,28,0.12), transparent 45%),
      radial-gradient(circle at bottom right, rgba(100,92,255,0.16), transparent 45%);
    opacity: 0.6;
    pointer-events: none;
  }

  /* LOGIN */
  .login-card {
    position: relative;
    z-index: 2;
    width: 100%;
    max-width: 520px;
    margin: auto;
    padding: 28px 28px 24px;
    border-radius: 28px;
    border: 1px solid rgba(255,255,255,0.06);
    background:
      radial-gradient(circle at top, rgba(255,255,255,0.07), transparent 55%),
      linear-gradient(135deg, rgba(32,32,36,0.98), rgba(13,13,18,0.96));
    box-shadow: var(--shadow-soft);
    display: flex;
    flex-direction: column;
    gap: 24px;
    backdrop-filter: blur(18px);
  }

  .login-header {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .logo-circle {
    width: 52px;
    height: 52px;
    border-radius: 22px;
    background:
      radial-gradient(circle at 20% 0%, #ffeaa7, transparent 55%),
      radial-gradient(circle at 80% 120%, #ff9f1c, transparent 55%),
      #111;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 14px 38px rgba(0,0,0,0.85);
    position: relative;
    overflow: hidden;
  }

  .logo-circle::after {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: inherit;
    border: 1px solid rgba(255,255,255,0.22);
    opacity: 0.8;
  }

  .logo-circle span {
    font-weight: 800;
    font-size: 18px;
    letter-spacing: 0.08em;
    color: #111;
    text-shadow: 0 0 12px rgba(255,255,255,0.85);
  }

  .login-title-block {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .login-title {
    font-size: 22px;
    font-weight: 700;
    letter-spacing: 0.06em;
    text-transform: uppercase;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .login-title span:nth-child(1) { color: #fff; }
  .login-title span:nth-child(2) { color: var(--accent); }

  .login-subtitle {
    font-size: 13px;
    color: var(--text-muted);
  }

  .login-row {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .login-label {
    font-size: 13px;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--text-muted);
  }

  .input-pill {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 10px 14px;
    border-radius: 999px;
    border: 1px solid var(--border-subtle);
    background:
      radial-gradient(circle at top left, rgba(255,255,255,0.04), transparent 60%),
      #16161a;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.03);
  }

  .input-pill:focus-within {
    border-color: var(--accent-border);
    box-shadow:
      0 0 0 1px rgba(255,255,255,0.02),
      0 0 0 1px var(--accent-border),
      var(--accent-glow);
  }

  .input-pill span.icon { font-size: 16px; opacity: 0.8; }

  .input-pill input {
    border: none;
    outline: none;
    background: transparent;
    color: var(--text-main);
    font-size: 14px;
    width: 100%;
    padding: 4px 0;
  }

  .input-pill input::placeholder { color: #6f6f7a; }

  .chip-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .chip {
    font-size: 11px;
    padding: 4px 10px;
    border-radius: var(--chip-radius);
    border: 1px solid rgba(255,255,255,0.08);
    background: rgba(12,12,16,0.9);
    color: var(--text-muted);
  }

  .chip.accent {
    border-color: var(--accent-border);
    background: var(--accent-soft);
    color: #ffd29c;
  }

  .chip.success {
    border-color: var(--success-border);
    background: var(--success-soft);
    color: #c2ffd9;
  }

  .chip.badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .chip.badge span.dot {
    width: 7px;
    height: 7px;
    border-radius: 999px;
    background: var(--success);
    box-shadow: 0 0 12px var(--success);
  }

  .login-footer-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 6px;
  }

  .status-pill {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 5px 11px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.08);
    background: rgba(12,12,16,0.96);
    font-size: 11px;
    color: var(--text-muted);
  }

  .status-pill-dot {
    width: 8px;
    height: 8px;
    border-radius: 999px;
    background: #6b6b75;
    box-shadow: 0 0 0 0 rgba(107,107,117,0.3);
    transition: all 0.25s ease;
  }

  .status-pill-dot.online {
    background: var(--success);
    box-shadow: 0 0 10px rgba(46,213,115,0.85);
  }

  .status-pill-label { white-space: nowrap; }

  .login-button {
    position: relative;
    border: none;
    outline: none;
    padding: 10px 22px;
    border-radius: 999px;
    background: linear-gradient(135deg,#ff9f1c,#ff7b00);
    color: #111;
    font-size: 14px;
    font-weight: 600;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 8px;
    box-shadow: 0 12px 24px rgba(0,0,0,0.8);
    transform: translateY(0);
    transition: all 0.18s ease;
  }

  .login-button span.icon { font-size: 16px; }

  .login-button:hover {
    transform: translateY(-1px);
    box-shadow: 0 16px 30px rgba(0,0,0,0.9);
  }

  .login-button:active {
    transform: translateY(1px) scale(0.99);
    box-shadow: 0 8px 18px rgba(0,0,0,0.9);
  }

  .login-meta-row {
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    color: #8a8a96;
    border-top: 1px solid rgba(255,255,255,0.05);
    padding-top: 8px;
    margin-top: 8px;
  }

  .login-meta-row span {
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .login-meta-row span small {
    padding: 2px 8px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.08);
    background: rgba(10,10,14,0.96);
    color: var(--text-muted);
  }

  .badge-beta {
    font-size: 11px;
    padding: 3px 10px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.14);
    background: linear-gradient(135deg, rgba(255,255,255,0.08), rgba(10,10,10,0.9));
    display: inline-flex;
    align-items: center;
    gap: 6px;
    color: var(--text-muted);
  }

  .badge-beta span.dot {
    width: 3px;
    height: 3px;
    border-radius: 999px;
    background: rgba(255,255,255,0.65);
  }

  .login-epg-row {
    display: flex;
    flex-direction: column;
    gap: 10px;
    margin-top: 4px;
  }

  .login-epg-row small {
    font-size: 11px;
    color: var(--text-muted);
  }

  .hint-text {
    font-size: 12px;
    color: #848491;
  }

  .hint-text code {
    font-size: 11px;
    padding: 2px 6px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.09);
    background: rgba(8,8,12,0.96);
  }

  /* APP SHELL */
  .app-shell {
    position: relative;
    z-index: 2;
    display: none;
    width: 100%;
    max-width: 1440px;
    height: 100%;
    border-radius: 28px;
    border: 1px solid rgba(255,255,255,0.06);
    background:
      radial-gradient(circle at top, rgba(255,255,255,0.06), transparent 50%),
      linear-gradient(135deg, rgba(20,20,24,0.98), rgba(7,7,12,0.98));
    box-shadow: var(--shadow-soft);
    overflow: hidden;
    display: flex;
    flex-direction: column;
  }

  .app-inner {
    display: flex;
    flex: 1;
    min-height: 0;
  }

  /* TOPBAR */
  .topbar {
    height: 58px;
    border-bottom: 1px solid rgba(255,255,255,0.06);
    display: flex;
    align-items: center;
    padding: 0 18px;
    gap: 18px;
    background:
      linear-gradient(to bottom, rgba(18,18,22,0.98), rgba(9,9,14,0.98));
    backdrop-filter: blur(18px);
    position: relative;
    z-index: 2;
  }

  .topbar-left {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .topbar-logo {
    width: 34px;
    height: 34px;
    border-radius: 14px;
    background:
      radial-gradient(circle at 0 0, #ffeaa7, transparent 60%),
      radial-gradient(circle at 120% 120%, #ff9f1c, transparent 60%),
      #111;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 10px 26px rgba(0,0,0,0.9);
    position: relative;
    overflow: hidden;
  }

  .topbar-logo::after {
    content: "";
    position: absolute;
    inset: 0;
    border-radius: inherit;
    border: 1px solid rgba(255,255,255,0.2);
    opacity: 0.8;
  }

  .topbar-logo span {
    font-weight: 800;
    font-size: 14px;
    letter-spacing: 0.08em;
    color: #111;
  }

  .topbar-title-block {
    display: flex;
    flex-direction: column;
    gap: 1px;
  }

  .topbar-title { font-size: 15px; font-weight: 600; }
  .topbar-subtitle { font-size: 11px; color: var(--text-muted); }

  .topbar-center {
    flex: 1;
    display: flex;
    justify-content: center;
  }

  .topbar-nav {
    display: inline-flex;
    align-items: center;
    gap: 16px;
    padding: 4px;
    border-radius: 999px;
    background:
      radial-gradient(circle at top, rgba(255,255,255,0.04), transparent 60%),
      #14141a;
    border: 1px solid rgba(255,255,255,0.08);
    box-shadow: var(--shadow-card);
  }

  .topbar-nav span {
    position: relative;
    font-size: 13px;
    padding: 4px 22px;
    border-radius: 999px;
    cursor: pointer;
    opacity: 0.7;
    color: #d0d0dd;
    transition: all 0.18s ease;
  }

  .topbar-nav span:hover { opacity: 1; }

  .topbar-nav span.active {
    background:
      radial-gradient(circle at 0 0, rgba(255,255,255,0.25), transparent 60%),
      linear-gradient(135deg,#ff9f1c,#ff7b00);
    color: #111;
    opacity: 1;
    box-shadow: 0 10px 26px rgba(0,0,0,0.9);
  }

  .topbar-right {
    display: flex;
    align-items: center;
    gap: 10px;
    font-size: 12px;
    color: var(--text-muted);
  }

  .profile-pill {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    padding: 5px 10px;
    border-radius: 999px;
    background: rgba(12,12,16,0.96);
    border: 1px solid rgba(255,255,255,0.08);
  }

  .profile-avatar {
    width: 20px;
    height: 20px;
    border-radius: 999px;
    background:
      radial-gradient(circle at 0 0, #ffeaa7, transparent 60%),
      radial-gradient(circle at 120% 120%, #ff9f1c, transparent 60%),
      #111;
  }

  .profile-name { font-size: 12px; color: #f3f3f6; }

  /* SIDEBAR */
  .sidebar {
    width: 260px;
    border-right: 1px solid rgba(255,255,255,0.07);
    background:
      linear-gradient(180deg, rgba(23,23,28,0.98), rgba(10,10,15,0.98));
    display: flex;
    flex-direction: column;
    min-height: 0;
  }

  .sidebar-inner {
    padding: 12px 12px 10px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    flex: 1;
    min-height: 0;
  }

  .sidebar-section-title {
    font-size: 11px;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    color: #7f7f8a;
    padding: 0 4px;
    margin-bottom: 2px;
  }

  .search-box {
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.08);
    padding: 7px 10px;
    display: flex;
    align-items: center;
    gap: 8px;
    background:
      radial-gradient(circle at top left, rgba(255,255,255,0.04), transparent 60%),
      #14141a;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
  }

  .search-box span.icon { font-size: 14px; opacity: 0.75; }

  .search-box input {
    border: none;
    outline: none;
    background: transparent;
    color: #f5f5ff;
    font-size: 13px;
    width: 100%;
  }

  .search-box input::placeholder { color: #757585; }

  .filter-chips {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    margin-top: 2px;
  }

  .filter-chips button {
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.08);
    padding: 4px 10px;
    background: rgba(12,12,16,0.96);
    color: var(--text-muted);
    font-size: 11px;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .filter-chips button.active {
    background: var(--accent-soft);
    border-color: var(--accent-border);
    color: #ffd29c;
  }

  .sidebar-list-wrapper {
    flex: 1;
    min-height: 0;
    border-radius: 20px;
    background:
      radial-gradient(circle at top, rgba(255,255,255,0.06), transparent 60%),
      #17171c;
    border: 1px solid rgba(255,255,255,0.06);
    box-shadow: var(--shadow-card);
    padding: 8px 6px 8px 8px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .sidebar-list-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 2px 4px 4px;
    font-size: 11px;
    color: var(--text-muted);
  }

  .sidebar-list-header strong { color: #f5f5ff; font-size: 12px; }

  .sidebar-list {
    flex: 1;
    min-height: 0;
    overflow-y: auto;
    padding-right: 4px;
  }

  .sidebar-item {
    border-radius: 999px;
    padding: 6px 9px;
    margin-bottom: 2px;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 12px;
    color: #d0d0e0;
    cursor: pointer;
  }

  .sidebar-item:hover { background: rgba(255,255,255,0.06); }
  .sidebar-item.active {
    background: var(--accent-soft);
    box-shadow: var(--accent-glow);
  }

  .sidebar-item-pill {
    width: 18px;
    height: 18px;
    border-radius: 999px;
    background: rgba(12,12,16,0.96);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
    color: var(--text-muted);
  }

  .sidebar-item-label {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }

  .sidebar-item-count { font-size: 11px; color: #86869a; }

  .sidebar-footer {
    padding: 6px 4px 2px;
    display: flex;
    justify-content: space-between;
    font-size: 11px;
    color: var(--text-muted);
  }

  .sidebar-footer span {
    display: inline-flex;
    align-items: center;
    gap: 5px;
  }

  .sidebar-footer span.dot {
    width: 4px;
    height: 4px;
    border-radius: 999px;
    background: rgba(255,255,255,0.7);
  }

  .sidebar-footer small {
    padding: 2px 8px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.08);
    background: rgba(10,10,16,0.96);
  }

  /* MAIN PANEL */
  .main-panel {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    min-height: 0;
    padding: 10px 12px 10px 10px;
  }

  .center-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 2px 2px 10px;
  }

  .center-title-block {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .center-title { font-size: 17px; font-weight: 600; }
  .center-subtitle { font-size: 12px; color: var(--text-muted); }

  .center-pill {
    border-radius: 999px;
    padding: 4px 10px;
    border: 1px solid rgba(255,255,255,0.08);
    background: rgba(10,10,16,0.96);
    font-size: 11px;
    color: var(--text-muted);
    display: inline-flex;
    align-items: center;
    gap: 6px;
  }

  .center-pill span.dot {
    width: 6px;
    height: 6px;
    border-radius: 999px;
    background: rgba(255,255,255,0.9);
  }

  .view-chips {
    display: inline-flex;
    align-items: center;
    border-radius: 999px;
    background: rgba(12,12,18,0.96);
    border: 1px solid rgba(255,255,255,0.08);
    padding: 2px;
    font-size: 11px;
  }

  .view-chips span {
    padding: 4px 10px;
    border-radius: 999px;
    cursor: pointer;
    color: var(--text-muted);
  }

  .view-chips span.active {
    background: var(--accent-soft);
    color: #ffd29c;
  }

  .content-and-player {
    flex: 1;
    min-height: 0;
    display: flex;
    gap: 10px;
  }

  .content-list-panel {
    flex: 1;
    min-width: 0;
    border-radius: 20px;
    background:
      radial-gradient(circle at top, rgba(255,255,255,0.05), transparent 60%),
      #16161c;
    border: 1px solid rgba(255,255,255,0.06);
    box-shadow: var(--shadow-card);
    display: flex;
    flex-direction: column;
    min-height: 0;
  }

  .list-header-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 8px 10px 6px;
    font-size: 12px;
    color: var(--text-muted);
    border-bottom: 1px solid rgba(255,255,255,0.05);
  }

  .list-header-row strong { color: #f5f5ff; }

  .list-header-right {
    display: inline-flex;
    align-items: center;
    gap: 10px;
  }

  .list-header-right button {
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.08);
    padding: 3px 10px;
    background: rgba(12,12,16,0.96);
    color: var(--text-muted);
    font-size: 11px;
    cursor: pointer;
  }

  .content-list {
    flex: 1;
    min-height: 0;
    overflow-y: auto;
  }

  .content-row {
    display: grid;
    grid-template-columns: 46px minmax(0,1fr) 90px;
    gap: 10px;
    padding: 8px 10px;
    border-bottom: 1px solid rgba(255,255,255,0.03);
    align-items: center;
    cursor: pointer;
  }

  .content-row:nth-child(2n) {
    background: rgba(255,255,255,0.02);
  }

  .content-row:hover {
    background: rgba(255,255,255,0.05);
  }

  .content-row.active {
    background: var(--accent-soft);
  }

  .content-thumb {
    width: 46px;
    height: 28px;
    border-radius: 9px;
    background: #333;
    overflow: hidden;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 11px;
  }

  .content-thumb img {
    width: 100%;
    height: 100%;
    object-fit: contain;
    background: #222;
  }

  .content-main {
    display: flex;
    flex-direction: column;
    gap: 1px;
  }

  .content-title { font-size: 13px; font-weight: 500; }
  .content-meta { font-size: 11px; color: var(--text-muted); }

  .content-right {
    text-align: right;
    font-size: 11px;
    color: var(--text-muted);
  }

  .content-right span.badge-live {
    border-radius: 999px;
    padding: 3px 7px;
    border: 1px solid rgba(255,71,87,0.7);
    background: rgba(255,71,87,0.18);
    color: #ffdede;
    font-size: 10px;
  }

  /* PLAYER */
  .player-panel {
    width: 420px;
    max-width: 44%;
    min-width: 320px;
    border-radius: 20px;
    background:
      radial-gradient(circle at top, rgba(255,255,255,0.05), transparent 60%),
      #181820;
    border: 1px solid rgba(255,255,255,0.06);
    box-shadow: var(--shadow-card);
    display: flex;
    flex-direction: column;
    min-height: 0;
  }

  .player-video-wrapper {
    position: relative;
    padding: 10px 10px 6px;
  }

  .player-video {
    width: 100%;
    aspect-ratio: 16 / 9;
    border-radius: 16px;
    background: #000;
    overflow: hidden;
    box-shadow: 0 12px 28px rgba(0,0,0,0.9);
  }

  video {
    width: 100%;
    height: 100%;
    display: block;
    background: #000;
  }

  .player-title-block {
    padding: 4px 10px 6px;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .player-title {
    font-size: 14px;
    font-weight: 500;
  }

  .player-meta {
    font-size: 11px;
    color: var(--text-muted);
  }

  .subtitle-select {
    margin-left: auto;
    border-radius: 999px;
    background: rgba(12,12,16,0.96);
    border: 1px solid rgba(255,255,255,0.15);
    color: var(--text-muted);
    font-size: 11px;
    padding: 3px 8px;
  }

  /* INFO / EPG-panel */
  .epg-panel {
    margin: 0 10px 10px;
    border-radius: 16px;
    background: rgba(10,10,14,0.96);
    border: 1px solid rgba(255,255,255,0.08);
    padding: 8px 10px 8px;
    display: flex;
    flex-direction: column;
    gap: 4px;
    max-height: 260px;
    min-height: 120px;
  }

  .epg-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-size: 11px;
    color: var(--text-muted);
  }

  .epg-list {
    flex: 1;
    min-height: 0;
    overflow-y: auto;
    margin-top: 2px;
    padding-right: 2px;
  }

  .epg-item {
    font-size: 11px;
    padding: 6px 0;
    display: flex;
    gap: 8px;
    color: var(--text-muted);
    border-bottom: 1px solid rgba(255,255,255,0.03);
  }

  .epg-item:last-child {
    border-bottom: none;
  }

  .epg-item span.time {
    min-width: 72px;
    color: #a2a2b3;
  }

  .epg-body {
    flex: 1;
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .epg-title {
    font-size: 11px;
  }

  .epg-desc {
    font-size: 10px;
    color: var(--text-muted);
  }

  .epg-item.current .epg-title {
    color: #fff;
    font-weight: 500;
  }

  .season-chip {
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.12);
    background: rgba(12,12,16,0.96);
    color: var(--text-muted);
    font-size: 10px;
    padding: 2px 8px;
    cursor: pointer;
  }
  .season-chip.active {
    background: var(--accent-soft);
    border-color: var(--accent-border);
    color: #ffd29c;
  }

  /* BOTTOM BAR */
  .bottom-bar {
    height: 30px;
    border-top: 1px solid rgba(255,255,255,0.06);
    display: flex;
    align-items: center;
    padding: 0 12px;
    font-size: 11px;
    color: var(--text-muted);
    background: rgba(7,7,10,0.98);
  }

  .bottom-bar-left, .bottom-bar-right {
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .bottom-bar-left { flex: 1; }

  .bottom-bar-left span.dot {
    width: 6px;
    height: 6px;
    border-radius: 999px;
    background: rgba(255,255,255,0.7);
  }

  .bottom-bar-right span {
    padding: 2px 8px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,0.08);
    background: rgba(12,12,16,0.96);
  }

  ::-webkit-scrollbar { width: 8px; }
  ::-webkit-scrollbar-track { background: var(--scrollbar-track); }
  ::-webkit-scrollbar-thumb {
    background: var(--scrollbar-thumb);
    border-radius: 999px;
  }
  ::-webkit-scrollbar-thumb:hover { background: var(--scrollbar-thumb-hover); }

  @media (max-width: 1100px) {
    .app-shell { border-radius: 0; }
    .app-root { padding: 0; }
    .player-panel { display: none; }
  }

  @media (max-width: 800px) {
    .sidebar { display: none; }
    .content-and-player { flex-direction: column; }
  }
</style>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>
<body>

<div class="app-root">

  <!-- LOGIN -->
  <div class="login-card" id="loginScreen">
    <div class="login-header">
      <div class="logo-circle">
        <span>LG</span>
      </div>
      <div class="login-title-block">
        <div class="login-title">
          <span>LIVEGO</span>
          <span>WEB TV</span>
        </div>
        <div class="login-subtitle">Direkt in i din portal ‚Äì Live TV, serier & filmer p√• samma st√§lle.</div>
      </div>
    </div>

    <div class="login-row">
      <div class="login-label">Server (f√∂rinst√§lld)</div>
      <div class="input-pill">
        <span class="icon">üåê</span>
        <input id="serverInput" type="text" readonly value="http://livego.club:8080" />
      </div>
      <div class="chip-row">
        <span class="chip accent">Livego Xtream</span>
        <span class="chip">M3U + XMLTV redo</span>
        <span class="chip badge">
          <span class="dot"></span>
          <span>HTTPS UI</span>
        </span>
      </div>
    </div>

    <div class="login-row">
      <div class="login-label">Inloggning (Xtream Codes)</div>
      <div class="input-pill">
        <span class="icon">üë§</span>
        <input id="usernameInput" type="text" placeholder="Anv√§ndarnamn" />
      </div>
      <div class="input-pill">
        <span class="icon">üîí</span>
        <input id="passwordInput" type="password" placeholder="L√∂senord" />
      </div>
    </div>

    <div class="login-row">
      <div class="login-label">M3U & EPG (valfritt men rekommenderas)</div>
      <div class="input-pill">
        <span class="icon">üì∫</span>
        <input id="m3uInput" type="text" placeholder="M3U-l√§nk (t.ex. get.php?username=...&password=...&type=m3u_plus&output=ts)" />
      </div>
      <div class="input-pill">
        <span class="icon">üïí</span>
        <input id="epgInput" type="text" placeholder="EPG / XMLTV-l√§nk (t.ex. xmltv.php?username=...&password=...)" />
      </div>
      <div class="login-epg-row">
        <small>Tipset: anv√§nd samma anv√§ndarnamn & l√∂senord som i din portal f√∂r M3U och XMLTV.</small>
        <div class="hint-text">
          Exempel:
          <code>http://livego.club:8080/get.php?username=DIN_USER&password=DITT_PASS&type=m3u_plus&output=ts</code>
        </div>
      </div>
    </div>

    <div class="login-footer-row">
      <div class="status-pill">
        <div class="status-pill-dot" id="statusDot"></div>
        <div class="status-pill-label" id="statusText">Ej ansluten</div>
      </div>

      <button class="login-button" id="loginBtn">
        <span class="icon">‚ñ∂</span>
        <span>Starta Livego</span>
      </button>
    </div>

    <div class="login-meta-row">
      <span>
        Profil:
        <small>Live TV + Serier + VOD</small>
      </span>
      <span>
        <span class="badge-beta">
          <span class="dot"></span>
          <span>Version 1.0 ‚Ä¢ Web UI</span>
        </span>
      </span>
    </div>
  </div>

  <!-- APP -->
  <div class="app-shell" id="app">
    <div class="topbar">
      <div class="topbar-left">
        <div class="topbar-logo"><span>LG</span></div>
        <div class="topbar-title-block">
          <div class="topbar-title">LIVEGO WEB TV</div>
          <div class="topbar-subtitle" id="portalLabel">Portal: livego.club</div>
        </div>
      </div>

      <div class="topbar-center">
        <div class="topbar-nav">
          <span data-view="live" class="active">Live TV</span>
          <span data-view="series">Serier</span>
          <span data-view="movies">Filmer</span>
        </div>
      </div>

      <div class="topbar-right">
        <span id="accountInfo">Ej inloggad</span>
        <div class="profile-pill">
          <div class="profile-avatar"></div>
          <div class="profile-name" id="profileName">G√§st</div>
        </div>
      </div>
    </div>

    <div class="app-inner">
      <!-- SIDEBAR -->
      <div class="sidebar">
        <div class="sidebar-inner">
          <div>
            <div class="sidebar-section-title">S√∂k</div>
            <div class="search-box">
              <span class="icon">üîç</span>
              <input id="searchInput" type="text" placeholder="S√∂k kanal, serie eller film..." />
            </div>
            <div class="filter-chips">
              <button data-filter="all" class="active">Alla</button>
              <button data-filter="favorites">Favoriter</button>
              <button data-filter="sweden">Sverige</button>
              <button data-filter="sports">Sport</button>
            </div>
          </div>

          <div class="sidebar-list-wrapper">
            <div class="sidebar-list-header">
              <strong>Kategorier</strong>
              <span id="categoryCountLabel">0 grupper</span>
            </div>
            <div class="sidebar-list" id="categoryList"></div>
          </div>

          <div class="sidebar-footer">
            <span>
              <span class="dot"></span>
              <span id="connectionLabel">Ingen str√∂m vald</span>
            </span>
            <span>
              <small id="timeLabel"></small>
            </span>
          </div>
        </div>
      </div>

      <!-- MAIN PANEL -->
      <div class="main-panel">
        <div class="center-header">
          <div class="center-title-block">
            <div class="center-title" id="centerTitle">V√§lj en kanal eller serie</div>
            <div class="center-subtitle" id="centerSub">Inga objekt inl√§sta √§nnu.</div>
          </div>
          <div style="display:flex;align-items:center;gap:10px;">
            <div class="center-pill">
              <span class="dot"></span>
              <span id="centerPill">0 objekt</span>
            </div>
            <div class="view-chips">
              <span data-viewchip="grid" class="active">Lista</span>
              <span data-viewchip="compact">Kompakt</span>
            </div>
          </div>
        </div>

        <div class="content-and-player">
          <!-- LIST -->
          <div class="content-list-panel">
            <div class="list-header-row">
              <span><strong>Inneh√•ll</strong> ‚Ä¢ <span id="currentViewLabel">Live TV</span></span>
              <div class="list-header-right">
                <button id="refreshBtn">Uppdatera</button>
              </div>
            </div>
            <div class="content-list" id="channelList"></div>
          </div>

          <!-- PLAYER + INFO/EPG -->
          <div class="player-panel">
            <div class="player-video-wrapper">
              <div class="player-video">
                <video id="videoPlayer" controls playsinline></video>
              </div>
            </div>
            <div class="player-title-block">
              <div class="player-title" id="playerTitle">Ingen kanal eller titel vald</div>
              <div class="player-meta" style="display:flex;align-items:center;gap:8px;">
                <span id="playerMetaLabel">V√§lj n√•got i listan till v√§nster f√∂r att starta.</span>
                <select id="subtitleSelect" class="subtitle-select">
                  <option value="-1">Undertext: Av</option>
                </select>
              </div>
            </div>
            <div class="epg-panel">
              <div class="epg-header">
                <span id="epgHeaderTitle">EPG / Nu & N√§sta</span>
                <span id="epgStatusLabel">Ingen EPG-l√§nk angiven</span>
              </div>
              <div class="epg-list" id="epgList"></div>
            </div>
          </div>
        </div>

        <div class="bottom-bar">
          <div class="bottom-bar-left">
            <span class="dot"></span>
            <span id="bottomLog">Redo.</span>
          </div>
          <div class="bottom-bar-right">
            <span id="bottomSummary">0 live ‚Ä¢ 0 serier ‚Ä¢ 0 filmer</span>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
  const LIVEGO_SERVER = "http://livego.club:8080";

  const loginScreenEl   = document.getElementById("loginScreen");
  const appEl           = document.getElementById("app");
  const loginBtn        = document.getElementById("loginBtn");
  const usernameInput   = document.getElementById("usernameInput");
  const passwordInput   = document.getElementById("passwordInput");
  const serverInput     = document.getElementById("serverInput");
  const m3uInput        = document.getElementById("m3uInput");
  const epgInput        = document.getElementById("epgInput");
  const statusDot       = document.getElementById("statusDot");
  const statusText      = document.getElementById("statusText");
  const portalLabel     = document.getElementById("portalLabel");
  const accountInfo     = document.getElementById("accountInfo");
  const profileName     = document.getElementById("profileName");
  const categoryListEl  = document.getElementById("categoryList");
  const categoryCountLabel = document.getElementById("categoryCountLabel");
  const connectionLabel = document.getElementById("connectionLabel");
  const timeLabel       = document.getElementById("timeLabel");
  const channelListEl   = document.getElementById("channelList");
  const centerTitleEl   = document.getElementById("centerTitle");
  const centerSubEl     = document.getElementById("centerSub");
  const centerPillEl    = document.getElementById("centerPill");
  const viewChipEl      = document.querySelector(".view-chips");
  const currentViewLabel= document.getElementById("currentViewLabel");
  const videoPlayer     = document.getElementById("videoPlayer");
  const playerTitleEl   = document.getElementById("playerTitle");
  const playerMetaLabel = document.getElementById("playerMetaLabel");
  const epgHeaderTitle  = document.getElementById("epgHeaderTitle");
  const epgListEl       = document.getElementById("epgList");
  const epgStatusLabel  = document.getElementById("epgStatusLabel");
  const bottomLogEl     = document.getElementById("bottomLog");
  const bottomSummary   = document.getElementById("bottomSummary");
  const topbarNav       = document.querySelector(".topbar-nav");
  const searchInput     = document.getElementById("searchInput");
  const filterChips     = document.querySelectorAll(".filter-chips button");
  const refreshBtn      = document.getElementById("refreshBtn");
  const subtitleSelect  = document.getElementById("subtitleSelect");

  const videoEl = videoPlayer; // alias

  let hls = null; // global HLS-instans

  const state = {
    host: LIVEGO_SERVER,
    username: "",
    password: "",
    m3uUrl: "",
    epgUrl: "",
    token: "",
    liveCategories: [],
    liveStreams: [],
    liveFiltered: [],
    seriesCategories: [],
    seriesList: [],
    seriesFiltered: [],
    vodCategories: [],
    vodList: [],
    vodFiltered: [],
    currentView: "live",
    currentCategory: null,
    viewMode: "grid",
    xmltv: null,
    useXmltv: false,
    currentSeries: null,
    currentSeriesEpisodes: [],
    currentSeriesSeason: null
  };

  setInterval(() => {
    const d = new Date();
    timeLabel.textContent = d.toLocaleTimeString("sv-SE", { hour: "2-digit", minute: "2-digit" });
  }, 1000);

  function log(msg) {
    const t = new Date().toLocaleTimeString();
    bottomLogEl.textContent = "[" + t + "] " + msg;
  }

  function clearSubtitleMenu() {
    if (!subtitleSelect) return;
    subtitleSelect.innerHTML = '<option value="-1">Undertext: Av</option>';
  }

  function maybeDecodeBase64(str) {
    const s = (str || "").trim();
    if (!s) return "";
    if (!/^[A-Za-z0-9+/=]+$/.test(s) || s.length % 4 !== 0) return s;
    try {
      return decodeURIComponent(escape(atob(s)));
    } catch (e) {
      return s;
    }
  }

  function buildApiUrl(extraParams) {
    const url = new URL(state.host.replace(/\/+$/,"") + "/player_api.php");
    url.searchParams.set("username", state.username);
    url.searchParams.set("password", state.password);
    if (extraParams) {
      for (const [k,v] of Object.entries(extraParams)) {
        url.searchParams.set(k, v);
      }
    }
    return url.toString();
  }

  async function fetchJson(url) {
    const res = await fetch(url);
    if (!res.ok) throw new Error("HTTP " + res.status);
    return res.json();
  }

  function normalizeSwedish(str) {
    if (!str) return "";
    const map = { "√•":"a", "√§":"a", "√∂":"o", "√Ö":"A", "√Ñ":"A", "√ñ":"O" };
    return str.replace(/[√•√§√∂√Ö√Ñ√ñ]/g, ch => map[ch] || ch);
  }

  function setOnline(isOnline) {
    if (isOnline) {
      statusDot.classList.add("online");
      statusText.textContent = "Ansluten";
    } else {
      statusDot.classList.remove("online");
      statusText.textContent = "Ej ansluten";
    }
  }

  async function connect() {
    state.host = LIVEGO_SERVER;

    const hasXtream = !!(state.host && state.username && state.password);
    const hasM3u    = !!state.m3uUrl;

    if (!hasXtream && !hasM3u) {
      alert("Inloggning misslyckades. Fyll i uppgifterna igen.");
      return;
    }

    loginScreenEl.style.display = "none";
    appEl.style.display = "block";
    centerTitleEl.textContent = "Laddar Livego...";
    centerSubEl.textContent   = "H√§mtar kanaler, serier, filmer och EPG...";
    centerPillEl.textContent  = "0 objekt";

    state.liveCategories = [];
    state.liveStreams    = [];
    state.liveFiltered   = [];
    state.seriesCategories = [];
    state.seriesList       = [];
    state.seriesFiltered   = [];
    state.vodCategories    = [];
    state.vodList          = [];
    state.vodFiltered      = [];
    state.xmltv = null;
    state.useXmltv = false;
    state.currentSeries = null;
    state.currentSeriesEpisodes = [];
    state.currentSeriesSeason = null;

    setOnline(false);
    statusText.textContent = "Ansluter...";
    log("H√§mtar data fr√•n Livego...");

    let xtreamOk = false;
    let m3uOk    = false;
    let epgOk    = false;

    const tasks = [];

    if (hasXtream) {
      tasks.push(
        loadXtreamData()
          .then(() => { xtreamOk = true; })
          .catch(err => {
            console.error(err);
            log("Xtream-fel: " + err.message);
          })
      );
    }

    if (hasM3u) {
      tasks.push(
        loadM3uPlaylist(state.m3uUrl)
          .then(m3uChannels => {
            if (m3uChannels && m3uChannels.length) {
              mergeM3uIntoState(m3uChannels);
              m3uOk = true;
            }
          })
          .catch(err => {
            console.error(err);
            log("M3U-fel: " + err.message);
          })
      );
    }

    if (state.epgUrl) {
      tasks.push(
        loadXmltv(state.epgUrl)
          .then(() => {
            state.useXmltv = true;
            epgOk = true;
          })
          .catch(err => {
            console.error(err);
            log("EPG-fel: " + err.message);
          })
      );
    }

    if (tasks.length) await Promise.all(tasks);

    if (!xtreamOk && !m3uOk) {
      setOnline(false);
      alert("Ingen data kunde h√§mtas. Kontrollera anv√§ndarnamn/l√∂senord eller M3U-l√§nk.");
      appEl.style.display = "none";
      loginScreenEl.style.display = "flex";
      return;
    }

    setOnline(true);
    log(
      "Live: " + state.liveStreams.length +
      " | Serier: " + state.seriesList.length +
      " | Filmer: " + state.vodList.length +
      (epgOk ? " | EPG: inl√§st" : "")
    );

    onViewChanged();
  }

  async function loadXtreamData() {
    const promises = [
      fetchJson(buildApiUrl({ action: "get_live_categories" })),
      fetchJson(buildApiUrl({ action: "get_live_streams" })),
      fetchJson(buildApiUrl({ action: "get_series_categories" })).catch(() => []),
      fetchJson(buildApiUrl({ action: "get_series" })).catch(() => []),
      fetchJson(buildApiUrl({ action: "get_vod_categories" })).catch(() => []),
      fetchJson(buildApiUrl({ action: "get_vod_streams" })).catch(() => [])
    ];

    const [
      liveCats,
      liveStreams,
      seriesCats,
      seriesList,
      vodCats,
      vodList
    ] = await Promise.all(promises);

    state.liveCategories = Array.isArray(liveCats) ? liveCats : [];
    state.liveStreams    = Array.isArray(liveStreams) ? liveStreams : [];
    state.seriesCategories = Array.isArray(seriesCats) ? seriesCats : [];
    state.seriesList       = Array.isArray(seriesList) ? seriesList : [];
    state.vodCategories    = Array.isArray(vodCats) ? vodCats : [];
    state.vodList          = Array.isArray(vodList) ? vodList : [];

    state.liveFiltered   = state.liveStreams.slice();
    state.seriesFiltered = state.seriesList.slice();
    state.vodFiltered    = state.vodList.slice();

    portalLabel.textContent = "Portal: " + state.host.replace(/^https?:\/\//,"");
    accountInfo.textContent = "Inloggad: " + (state.username || "ok√§nd");
    profileName.textContent = state.username || "Livego";

    updateSidebarCategories();
    updateSummary();
  }

  async function loadM3uPlaylist(url) {
    log("H√§mtar M3U-lista...");
    const res = await fetch(url);
    if (!res.ok) throw new Error("M3U HTTP " + res.status);
    const text = await res.text();

    const lines = text.split(/\r?\n/);
    const channels = [];
    let current = null;
    const extinfRe = /^#EXTINF:-?\d*\s*(.*?),\s*(.+)$/i;

    for (let i = 0; i < lines.length; i++) {
      const line = lines[i].trim();
      if (!line) continue;

      if (line.startsWith("#EXTINF:")) {
        const m = line.match(extinfRe);
        if (!m) continue;
        const attrsPart = m[1] || "";
        const name = m[2] || "Ok√§nd kanal";

        function getAttr(attr) {
          const re = new RegExp(attr + '="([^"]*)"', "i");
          const mm = attrsPart.match(re);
          return mm ? mm[1] : "";
        }

        const tvgId      = getAttr("tvg-id");
        const groupTitle = getAttr("group-title");
        const logo       = getAttr("tvg-logo");

        current = {
          name,
          tvgId,
          groupTitle,
          logo,
          url: ""
        };
      } else if (current && !line.startsWith("#")) {
        current.url = line;
        channels.push(current);
        current = null;
      }
    }

    log("M3U: " + channels.length + " kanaler hittade.");
    return channels;
  }

  function mergeM3uIntoState(m3uChannels) {
    const byName = new Map();
    state.liveStreams.forEach(ch => {
      const key = normalizeSwedish(ch.name || ch.stream_display_name || "").toLowerCase();
      if (!byName.has(key)) byName.set(key, []);
      byName.get(key).push(ch);
    });

    m3uChannels.forEach(mch => {
      const key = normalizeSwedish(mch.name).toLowerCase();
      const matches = byName.get(key);
      if (matches && matches.length) {
        matches.forEach(ch => {
          ch.m3u_url   = mch.url;
          ch.tvg_id    = mch.tvgId || ch.tvg_id;
          ch.group_title = mch.groupTitle || ch.category_name;
          ch.logo      = mch.logo || ch.logo;
        });
      } else {
        state.liveStreams.push({
          stream_id: "m3u_" + mch.name,
          name: mch.name,
          stream_display_name: mch.name,
          category_name: mch.groupTitle || "M3U",
          m3u_url: mch.url,
          tvg_id: mch.tvgId,
          logo: mch.logo
        });
      }
    });

    const grouped = {};
    state.liveStreams.forEach(ch => {
      const catName = ch.category_name || "Ok√§nd";
      if (!grouped[catName]) grouped[catName] = 0;
      grouped[catName]++;
    });

    const existingIds = new Set(state.liveCategories.map(c => c.category_id));
    Object.keys(grouped).forEach(catName => {
      const catId = catName.toLowerCase().replace(/\s+/g,"_");
      if (!existingIds.has(catId)) {
        state.liveCategories.push({
          category_id: catId,
          category_name: catName
        });
        existingIds.add(catId);
      }
    });
  }

  async function loadXmltv(url) {
    log("H√§mtar EPG (XMLTV)...");
    const res = await fetch(url);
    if (!res.ok) throw new Error("EPG HTTP " + res.status);
    const text = await res.text();

    const parser = new DOMParser();
    const doc = parser.parseFromString(text, "text/xml");

    const channels = [];
    const programmes = [];

    const chNodes = doc.querySelectorAll("tv > channel");
    chNodes.forEach(ch => {
      channels.push({
        id: ch.getAttribute("id"),
        name: ch.querySelector("display-name")?.textContent || ""
      });
    });

    const progNodes = doc.querySelectorAll("tv > programme");
    progNodes.forEach(p => {
      programmes.push({
        channel: p.getAttribute("channel"),
        start: p.getAttribute("start"),
        stop: p.getAttribute("stop"),
        title: p.querySelector("title")?.textContent || "",
        desc: p.querySelector("desc")?.textContent || ""
      });
    });

    state.xmltv = { channels, programmes };
    log("EPG: " + programmes.length + " program inl√§sta fr√•n XMLTV.");
  }

  function updateSummary() {
    bottomSummary.textContent =
      state.liveStreams.length + " live ‚Ä¢ " +
      state.seriesList.length + " serier ‚Ä¢ " +
      state.vodList.length + " filmer";
  }

  function updateSidebarCategories() {
    const container = categoryListEl;
    container.innerHTML = "";

    let cats = [];
    if (state.currentView === "live") cats = state.liveCategories;
    if (state.currentView === "series") cats = state.seriesCategories;
    if (state.currentView === "movies") cats = state.vodCategories;

    categoryCountLabel.textContent = (cats ? cats.length : 0) + " grupper";

    if (!cats || !cats.length) {
      const div = document.createElement("div");
      div.style.fontSize = "12px";
      div.style.color = "#888";
      div.style.padding = "4px 6px";
      div.textContent = "Inga kategorier inl√§sta.";
      container.appendChild(div);
      return;
    }

    cats.forEach(cat => {
      const item = document.createElement("div");
      item.className = "sidebar-item";
      item.dataset.id = cat.category_id;

      const pill = document.createElement("div");
      pill.className = "sidebar-item-pill";
      pill.textContent = (cat.category_name || "?").charAt(0).toUpperCase();

      const label = document.createElement("div");
      label.className = "sidebar-item-label";
      label.textContent = cat.category_name || "Ok√§nd kategori";

      const count = document.createElement("div");
      count.className = "sidebar-item-count";
      let n = 0;
      if (state.currentView === "live") {
        n = state.liveStreams.filter(ch =>
          (ch.category_id + "") === (cat.category_id + "") ||
          (ch.category_name === cat.category_name)
        ).length;
      } else if (state.currentView === "series") {
        n = state.seriesList.filter(s => (s.category_id + "") === (cat.category_id + "")).length;
      } else if (state.currentView === "movies") {
        n = state.vodList.filter(v => (v.category_id + "") === (cat.category_id + "")).length;
      }
      count.textContent = n;

      item.appendChild(pill);
      item.appendChild(label);
      item.appendChild(count);
      item.addEventListener("click", () => {
        document.querySelectorAll(".sidebar-item").forEach(el => el.classList.remove("active"));
        item.classList.add("active");
        state.currentCategory = cat;
        onViewChanged();
      });

      container.appendChild(item);
    });
  }

  function onViewChanged() {
    let list = [];
    if (state.currentView === "live") {
      list = state.liveStreams.slice();
      currentViewLabel.textContent = "Live TV";
    }
    if (state.currentView === "series") {
      list = state.seriesList.slice();
      currentViewLabel.textContent = "Serier";
    }
    if (state.currentView === "movies") {
      list = state.vodList.slice();
      currentViewLabel.textContent = "Filmer";
    }

    const q = (searchInput.value || "").toLowerCase();
    if (q) {
      list = list.filter(item => {
        const name = (item.name || item.title || item.stream_display_name || "").toLowerCase();
        return name.includes(q);
      });
    }

    if (state.currentCategory) {
      list = list.filter(item => {
        const catId  = (item.category_id + "");
        const catName= item.category_name;
        return (catId === (state.currentCategory.category_id + "")) ||
               (catName === state.currentCategory.category_name);
      });
    }

    if (state.currentView === "live")   state.liveFiltered   = list;
    if (state.currentView === "series") state.seriesFiltered = list;
    if (state.currentView === "movies") state.vodFiltered    = list;

    renderContentList(list);
  }

  function renderContentList(list) {
    channelListEl.innerHTML = "";

    if (!list || !list.length) {
      centerTitleEl.textContent = "Inga objekt hittades";
      if (state.currentView === "live") {
        centerSubEl.textContent = "Kontrollera inloggning, kategori eller M3U/EPG-l√§nkar.";
      } else if (state.currentView === "series") {
        centerSubEl.textContent = "Inga serier hittades i denna kategori.";
      } else {
        centerSubEl.textContent = "Inga filmer hittades i denna kategori.";
      }
      centerPillEl.textContent = "0 objekt";
      return;
    }

    centerTitleEl.textContent = "V√§lj n√•got att spela upp";
    centerSubEl.textContent   = list.length + " objekt inl√§sta i aktuell vy.";
    centerPillEl.textContent  = list.length + " objekt";

    list.forEach(item => {
      const displayName = item.name || item.title || item.stream_display_name || "Ok√§nt namn";

      const row = document.createElement("div");
      row.className = "content-row";

      const thumb = document.createElement("div");
      thumb.className = "content-thumb";

      const logoUrl = item.stream_icon || item.logo || item.tvg_logo || item.movie_image;
      if (logoUrl) {
        const img = document.createElement("img");
        img.src = logoUrl;
        img.alt = displayName;
        thumb.appendChild(img);
      } else {
        thumb.textContent = displayName.substring(0, 3).toUpperCase();
      }

      const main = document.createElement("div");
      main.className = "content-main";

      const title = document.createElement("div");
      title.className = "content-title";
      title.textContent = displayName;

      const meta = document.createElement("div");
      meta.className = "content-meta";

      if (state.currentView === "live") {
        const cat = item.category_name || "";
        meta.textContent = cat || "Live-kanal";
      } else if (state.currentView === "series") {
        meta.textContent = "Serie ‚Ä¢ ok√§nd l√§ngd";
      } else if (state.currentView === "movies") {
        const year = item.releaseDate || item.releasedate || item.year || "ok√§nt √•r";
        meta.textContent = "Film ‚Ä¢ " + year;
      }

      main.appendChild(title);
      main.appendChild(meta);

      const right = document.createElement("div");
      right.className = "content-right";

      if (state.currentView === "live") {
        const badge = document.createElement("span");
        badge.className = "badge-live";
        badge.textContent = "LIVE";
        right.appendChild(badge);
      }

      row.appendChild(thumb);
      row.appendChild(main);
      row.appendChild(right);

      row.addEventListener("click", () => {
        document.querySelectorAll(".content-row").forEach(el => el.classList.remove("active"));
        row.classList.add("active");
        if (state.currentView === "series") {
          openSeries(item);
        } else {
          playItem(item);
        }
      });

      channelListEl.appendChild(row);
    });
  }

  // --- uppspelning beroende p√• vy ---
  function playItem(item) {
    if (state.currentView === "live") {
      playLiveChannel(item);
    } else if (state.currentView === "movies") {
      playMovie(item);
    }
  }

  function playLiveChannel(ch) {
    const name =
      ch.name ||
      ch.stream_display_name ||
      "Ok√§nd kanal";

    let url =
      ch.m3u_url   ||
      ch.stream_url ||
      ch.url        ||
      null;

    if (!url && ch.stream_id && state.host && state.username && state.password) {
      const base = state.host.replace(/\/+$/,"");
      url = base + "/live/" +
        encodeURIComponent(state.username) + "/" +
        encodeURIComponent(state.password) + "/" +
        encodeURIComponent(ch.stream_id) + ".m3u8";
    }

    if (!url) {
      log("Ingen stream-url hittad f√∂r denna kanal.");
      return;
    }

    playerTitleEl.textContent   = name;
    playerMetaLabel.textContent = "Spelar via: " + state.host.replace(/^https?:\/\//,"");
    connectionLabel.textContent = "Live: " + name;

    playInVideo(url);
    updateEpgForLiveChannel(ch);
  }

  function playMovie(item) {
    const name =
      item.name ||
      item.title ||
      "Ok√§nd film";

    let url =
      item.direct_source ||
      item.stream_url    ||
      item.url           ||
      null;

    if (!url && item.stream_id && state.host && state.username && state.password) {
      const base = state.host.replace(/\/+$/,"");
      const ext  = (item.container_extension || "mp4").replace(/^\./,"");
      url = base + "/movie/" +
        encodeURIComponent(state.username) + "/" +
        encodeURIComponent(state.password) + "/" +
        encodeURIComponent(item.stream_id) + "." + ext;
    }

    if (!url) {
      log("Ingen stream-url hittad f√∂r denna film.");
      return;
    }

    playerTitleEl.textContent   = name;
    playerMetaLabel.textContent = "Spelar via: " + state.host.replace(/^https?:\/\//,"");
    connectionLabel.textContent = "Film: " + name;

    playInVideo(url);

    epgHeaderTitle.textContent = "Info";
    epgStatusLabel.textContent = "H√§mtar info om filmen...";
    epgListEl.innerHTML = "";
    updateVodInfo(item);
  }

  // --- SERIER ---

  async function openSeries(seriesItem) {
    state.currentSeries = seriesItem;
    state.currentSeriesEpisodes = [];
    state.currentSeriesSeason = null;

    const name = seriesItem.name || seriesItem.title || "Ok√§nd serie";
    playerTitleEl.textContent = name;
    playerMetaLabel.textContent = "Serie: v√§lj s√§song och avsnitt";

    epgHeaderTitle.textContent = "S√§songer & avsnitt";
    epgStatusLabel.textContent = "Laddar serie-info...";
    epgListEl.innerHTML = "";

    if (!seriesItem.series_id) {
      epgStatusLabel.textContent = "Ingen serie-ID ‚Äì kan inte l√§sa avsnitt.";
      return;
    }

    try {
      const data = await fetchJson(buildApiUrl({
        action: "get_series_info",
        series_id: seriesItem.series_id
      }));

      const episodesObj = data.episodes || {};
      const episodes = [];

      Object.keys(episodesObj).forEach(seasonKey => {
        const seasonEpisodes = episodesObj[seasonKey] || [];
        seasonEpisodes.forEach(ep => {
          episodes.push({
            ...ep,
            season: seasonKey
          });
        });
      });

      if (!episodes.length) {
        epgStatusLabel.textContent = "Inga avsnitt hittades.";
        epgListEl.innerHTML = "";
        return;
      }

      state.currentSeriesEpisodes = episodes;
      const seasons = [...new Set(episodes.map(e => e.season))].sort(
        (a,b) => parseInt(a,10) - parseInt(b,10)
      );
      state.currentSeriesSeason = seasons[0];

      const seriesInfo = data.info || {};
      renderSeriesEpisodesPanel(seriesItem, seasons, seriesInfo);

      epgStatusLabel.textContent = "Serie: " + seasons.length + " s√§songer, " + episodes.length + " avsnitt";
      log("Serie-info: " + name + " ‚Äì " + seasons.length + " s√§songer.");
    } catch (e) {
      console.error(e);
      epgStatusLabel.textContent = "Kunde inte h√§mta serie-info.";
    }
  }

  // NY version med program-info (plot) avkodad
  function renderSeriesEpisodesPanel(seriesItem, seasons, info) {
    epgListEl.innerHTML = "";

    info = info || {};

    const infoRow = document.createElement("div");
    infoRow.className = "epg-item";

    const infoLabel = document.createElement("span");
    infoLabel.className = "time";
    infoLabel.textContent = "Info";

    const infoBody = document.createElement("div");
    infoBody.className = "epg-body";

    const title = seriesItem.name || seriesItem.title || "Ok√§nd serie";
    const year   = info.releaseDate || info.release_date || info.year || "";
    const genre  = info.genre || "";
    const rating = info.rating || info.rating_5based || "";
    const plot   = maybeDecodeBase64(info.plot || "");

    const titleDiv = document.createElement("div");
    titleDiv.className = "epg-title";
    titleDiv.textContent = title + (year ? " (" + year + ")" : "");

    const metaDiv = document.createElement("div");
    metaDiv.className = "epg-desc";
    let metaText = "";
    if (genre)  metaText += "Genre: " + genre;
    if (rating) metaText += (metaText ? " ‚Ä¢ " : "") + "Betyg: " + rating + "/10";
    metaDiv.textContent = metaText;

    const plotDiv = document.createElement("div");
    plotDiv.className = "epg-desc";
    plotDiv.textContent = plot;

    infoBody.appendChild(titleDiv);
    if (metaText) infoBody.appendChild(metaDiv);
    if (plot)     infoBody.appendChild(plotDiv);

    infoRow.appendChild(infoLabel);
    infoRow.appendChild(infoBody);
    epgListEl.appendChild(infoRow);

    const seasonRow = document.createElement("div");
    seasonRow.className = "epg-item";

    const seasonLabel = document.createElement("span");
    seasonLabel.className = "time";
    seasonLabel.textContent = "S√§song";

    const seasonBody = document.createElement("div");
    seasonBody.className = "epg-body";

    const chipContainer = document.createElement("div");
    chipContainer.style.display = "flex";
    chipContainer.style.flexWrap = "wrap";
    chipContainer.style.gap = "6px";

    seasons.forEach(season => {
      const btn = document.createElement("button");
      btn.className = "season-chip" + (season == state.currentSeriesSeason ? " active" : "");
      btn.textContent = "S" + season;
      btn.addEventListener("click", () => {
        state.currentSeriesSeason = season;
        chipContainer.querySelectorAll(".season-chip").forEach(b => b.classList.remove("active"));
        btn.classList.add("active");
        renderSeriesEpisodesList(seriesItem);
      });
      chipContainer.appendChild(btn);
    });

    seasonBody.appendChild(chipContainer);
    seasonRow.appendChild(seasonLabel);
    seasonRow.appendChild(seasonBody);
    epgListEl.appendChild(seasonRow);

    const episodesContainer = document.createElement("div");
    episodesContainer.id = "seriesEpisodesContainer";
    epgListEl.appendChild(episodesContainer);

    renderSeriesEpisodesList(seriesItem);
  }

  // NY version ‚Äì avsnittsbeskrivning avkodad
  function renderSeriesEpisodesList(seriesItem) {
    const container = document.getElementById("seriesEpisodesContainer");
    if (!container) return;
    container.innerHTML = "";

    const season = state.currentSeriesSeason;
    const episodes = state.currentSeriesEpisodes.filter(e => e.season == season);

    episodes.sort((a,b) => (a.episode_num || 0) - (b.episode_num || 0));

    episodes.forEach(ep => {
      const row = document.createElement("div");
      row.className = "epg-item";

      const timeSpan = document.createElement("span");
      timeSpan.className = "time";
      const epNum = ep.episode_num || ep.episode || "?";
      timeSpan.textContent = "S" + season + " ‚Ä¢ E" + epNum;

      const body = document.createElement("div");
      body.className = "epg-body";

      const titleDiv = document.createElement("div");
      titleDiv.className = "epg-title";
      titleDiv.textContent = ep.title || ep.name || ("Avsnitt " + epNum);

      const descDiv = document.createElement("div");
      descDiv.className = "epg-desc";
      const infoObj = ep.info && typeof ep.info === "object" ? ep.info : {};
      const descRaw  = infoObj.plot || infoObj.description || ep.plot || "";
      const descText = maybeDecodeBase64(descRaw);
      descDiv.textContent = descText;

      body.appendChild(titleDiv);
      if (descText) body.appendChild(descDiv);

      row.appendChild(timeSpan);
      row.appendChild(body);

      row.addEventListener("click", () => {
        playSeriesEpisode(seriesItem, ep);
      });

      container.appendChild(row);
    });
  }

  function playSeriesEpisode(seriesItem, ep) {
    const seriesName = seriesItem.name || seriesItem.title || "Ok√§nd serie";

    let url =
      ep.direct_source ||
      ep.stream_url    ||
      ep.url           ||
      null;

    const epId =
      ep.id ||
      ep.episode_id ||
      ep.stream_id ||
      (ep.info && (ep.info.id || ep.info.stream_id || ep.info.movie_id));

    const base = state.host.replace(/\/+$/,"");
    const ext  = (
      ep.container_extension ||
      (ep.info && ep.info.container_extension) ||
      "mp4"
    ).replace(/^\./,"");

    if (!url && epId && state.host && state.username && state.password) {
      url = base + "/series/" +
        encodeURIComponent(state.username) + "/" +
        encodeURIComponent(state.password) + "/" +
        encodeURIComponent(epId) + "." + ext;
    }

    if (!url) {
      log("Ingen stream-url hittad f√∂r detta avsnitt.");
      return;
    }

    const epNum = ep.episode_num || ep.episode || "?";
    const season = ep.season || "?";

    const epTitle = seriesName + " ‚Äì S" + season + "E" + epNum;

    playerTitleEl.textContent   = epTitle;
    playerMetaLabel.textContent = ep.title || ("Avsnitt " + epNum);
    connectionLabel.textContent = "Serie: " + epTitle;

    playInVideo(url);

    epgHeaderTitle.textContent = "S√§songer & avsnitt";
  }

  // --- undertexter ---

  function populateSubtitleMenuFromHls(tracks) {
    clearSubtitleMenu();
    if (!tracks || !tracks.length) return;

    tracks.forEach((t, index) => {
      const opt = document.createElement("option");
      opt.value = index;
      const lang = t.lang || "";
      const name = t.name || t.label || ("Sp√•r " + (index + 1));
      opt.textContent = "Undertext: " + (lang ? lang.toUpperCase() + " ‚Äì " + name : name);
      subtitleSelect.appendChild(opt);
    });
  }

  function populateSubtitleMenuFromNativeTracks() {
    clearSubtitleMenu();
    const tracks = videoEl.textTracks;
    if (!tracks || !tracks.length) return;

    for (let i = 0; i < tracks.length; i++) {
      const t = tracks[i];
      const opt = document.createElement("option");
      opt.value = i;
      const lang = t.language || "";
      const label = t.label || ("Sp√•r " + (i + 1));
      opt.textContent = "Undertext: " + (lang ? lang.toUpperCase() + " ‚Äì " + label : label);
      subtitleSelect.appendChild(opt);
    }
  }

  if (subtitleSelect) {
    subtitleSelect.addEventListener("change", () => {
      const val = parseInt(subtitleSelect.value, 10);

      if (isNaN(val) || val < 0) {
        if (hls) {
          hls.subtitleTrack = -1;
        }
        const tracks = videoEl.textTracks;
        for (let i = 0; i < tracks.length; i++) {
          tracks[i].mode = "disabled";
        }
        return;
      }

      if (hls) {
        hls.subtitleTrack = val;
        const tracks = videoEl.textTracks;
        for (let i = 0; i < tracks.length; i++) {
          tracks[i].mode = (i === val ? "showing" : "disabled");
        }
      } else {
        const tracks = videoEl.textTracks;
        for (let i = 0; i < tracks.length; i++) {
          tracks[i].mode = (i === val ? "showing" : "disabled");
        }
      }
    });
  }

  // --- generisk uppspelning (HLS + vanliga filer) ---
  function playInVideo(url) {
    if (!url) return;

    const lowerUrl = url.toLowerCase();

    clearSubtitleMenu();

    if (window.Hls && Hls.isSupported() && lowerUrl.includes(".m3u8")) {
      if (hls) {
        try { hls.destroy(); } catch (e) {}
      }

      hls = new Hls({
        enableWebVTT: true,
        enableCEA708Captions: true,
        maxBufferLength: 60,
        liveSyncDuration: 10
      });

      hls.loadSource(url);
      hls.attachMedia(videoEl);

      hls.on(Hls.Events.SUBTITLE_TRACKS_UPDATED, function (event, data) {
        populateSubtitleMenuFromHls(data.subtitleTracks || []);
      });

      hls.on(Hls.Events.MANIFEST_PARSED, function () {
        videoEl.play().catch(() => {});
      });

      return;
    }

    videoEl.src = url;
    videoEl.load();

    videoEl.onloadedmetadata = function () {
      populateSubtitleMenuFromNativeTracks();
    };

    videoEl.play().catch(() => {});
  }

  videoEl.addEventListener("error", () => {
    if (!videoEl.error) return;
    const codes = {
      1: "MEDIA_ERR_ABORTED",
      2: "MEDIA_ERR_NETWORK",
      3: "MEDIA_ERR_DECODE",
      4: "MEDIA_ERR_SRC_NOT_SUPPORTED"
    };
    const msg = codes[videoEl.error.code] || ("Felkod " + videoEl.error.code);
    log("Video-fel: " + msg);
  });

  // --- EPG / INFO ---

  async function updateEpgForLiveChannel(item) {
    epgStatusLabel.textContent = "Laddar EPG...";
    epgListEl.innerHTML = "";

    if (state.useXmltv && state.xmltv && state.xmltv.channels && state.xmltv.programmes) {
      let tvgId = item.tvg_id;
      if (!tvgId) {
        const name = (item.name || item.stream_display_name || "").toLowerCase();
        const ch = state.xmltv.channels.find(c => (c.name || "").toLowerCase() === name);
        tvgId = ch ? ch.id : null;
      }

      if (tvgId) {
        const now = new Date();
        const progs = state.xmltv.programmes
          .filter(p => p.channel === tvgId)
          .filter(p => {
            const start = parseXmltvDate(p.start);
            const stop  = parseXmltvDate(p.stop);
            return start && stop && stop > now && start < (now.getTime() + 6 * 60 * 60 * 1000);
          })
          .sort((a,b) => parseXmltvDate(a.start) - parseXmltvDate(b.start));

        if (progs.length) {
          renderXmltvEpg(progs);
          epgStatusLabel.textContent = "EPG (XMLTV) ‚Äì " + progs.length + " program";
          log("EPG (XMLTV): " + progs.length + " program f√∂r kanal.");
          return;
        }
      }
      log("Ingen match i XMLTV, h√§mtar kort-EPG fr√•n portal...");
    }

    const list = await fetchShortEpg(item);
    if (!list || !list.length) {
      epgStatusLabel.textContent = "Ingen EPG hittades f√∂r denna kanal.";
      epgListEl.innerHTML = "";
      return;
    }
    renderShortEpg(list);
    epgStatusLabel.textContent = "EPG via portal ‚Äì " + list.length + " program";
    log("EPG (portal): " + list.length + " program f√∂r kanal.");
  }

  async function fetchShortEpg(item) {
    if (!state.host || !state.username || !state.password || !item.stream_id) return null;
    try {
      const data = await fetchJson(buildApiUrl({
        action: "get_short_epg",
        stream_id: item.stream_id,
        limit: 10
      }));
      const list = data.epg_listings || data || [];
      return Array.isArray(list) ? list : [];
    } catch (e) {
      console.warn("EPG error", e);
      log("EPG-fel (kort-EPG): " + e.message);
      return null;
    }
  }

  async function updateVodInfo(item) {
    epgListEl.innerHTML = "";

    if (!state.host || !state.username || !state.password || !item.stream_id) {
      epgStatusLabel.textContent = "Ingen info tillg√§nglig.";
      return;
    }

    try {
      const data = await fetchJson(buildApiUrl({
        action: "get_vod_info",
        vod_id: item.stream_id
      }));

      const info = data.info || {};
      const movie = data.movie_data || {};

      const year   = info.releasedate || movie.releasedate || movie.year || "";
      const genre  = info.genre || movie.category_name || "";
      const length = info.duration || info.episode_run_time || "";
      const rating = info.rating || info.rating_5based || movie.rating || "";
      const cast   = info.cast || "";
      const director = info.director || "";
      const plot   = maybeDecodeBase64(info.plot || "");
      const containerExt = item.container_extension || movie.container_extension || "";

      epgStatusLabel.textContent = "Info fr√•n portal";

      function addRow(label, text) {
        if (!text) return;
        const row = document.createElement("div");
        row.className = "epg-item";

        const left = document.createElement("span");
        left.className = "time";
        left.textContent = label;

        const body = document.createElement("div");
        body.className = "epg-body";

        const t = document.createElement("div");
        t.className = "epg-title";
        t.textContent = text;

        body.appendChild(t);
        row.appendChild(left);
        row.appendChild(body);
        epgListEl.appendChild(row);
      }

      addRow("√Ör", year);
      addRow("Genre", genre);
      addRow("L√§ngd", length);
      addRow("Betyg", rating ? rating + " / 10" : "");
      addRow("Regi", director);
      addRow("Medverkande", cast);

      if (plot) {
        const row = document.createElement("div");
        row.className = "epg-item";
        const left = document.createElement("span");
        left.className = "time";
        left.textContent = "Beskrivning";
        const body = document.createElement("div");
        body.className = "epg-body";
        const t = document.createElement("div");
        t.className = "epg-desc";
        t.textContent = plot;
        body.appendChild(t);
        row.appendChild(left);
        row.appendChild(body);
        epgListEl.appendChild(row);
      }

      if (containerExt) {
        addRow("Format", containerExt.toUpperCase());
      }

      if (!epgListEl.children.length) {
        epgStatusLabel.textContent = "Ingen extra info hittades.";
      }
    } catch (e) {
      console.error(e);
      epgStatusLabel.textContent = "Kunde inte h√§mta info om filmen.";
    }
  }

  function renderXmltvEpg(progs) {
    epgListEl.innerHTML = "";
    const now = Date.now();

    progs.forEach(p => {
      const startMs = parseXmltvDate(p.start);
      const stopMs  = parseXmltvDate(p.stop);
      if (!startMs || !stopMs) return;

      const div = document.createElement("div");
      div.className = "epg-item";
      if (startMs <= now && now < stopMs) div.classList.add("current");

      const timeSpan = document.createElement("span");
      timeSpan.className = "time";
      timeSpan.textContent = formatTime(startMs) + " - " + formatTime(stopMs);

      const body = document.createElement("div");
      body.className = "epg-body";

      const titleDiv = document.createElement("div");
      titleDiv.className = "epg-title";
      titleDiv.textContent = p.title || "Ok√§nt program";

      const descDiv = document.createElement("div");
      descDiv.className = "epg-desc";
      descDiv.textContent = p.desc || "";

      body.appendChild(titleDiv);
      if (descDiv.textContent) body.appendChild(descDiv);

      div.appendChild(timeSpan);
      div.appendChild(body);
      epgListEl.appendChild(div);
    });
  }

  function renderShortEpg(list) {
    epgListEl.innerHTML = "";
    list.forEach(item => {
      const row = document.createElement("div");
      row.className = "epg-item";

      const start = item.start || item.start_timestamp || "";
      const end   = item.end   || item.end_timestamp   || "";
      const timeText = formatEpgTime(start, end);

      const timeSpan = document.createElement("span");
      timeSpan.className = "time";
      timeSpan.textContent = timeText;

      const body = document.createElement("div");
      body.className = "epg-body";

      const titleDiv = document.createElement("div");
      titleDiv.className = "epg-title";
      const titleText = maybeDecodeBase64(item.title || "");
      titleDiv.textContent = titleText;

      const descDiv = document.createElement("div");
      descDiv.className = "epg-desc";
      const descText = maybeDecodeBase64(
        item.description || item.short_description || ""
      );
      descDiv.textContent = descText;

      body.appendChild(titleDiv);
      if (descDiv.textContent) body.appendChild(descDiv);

      row.appendChild(timeSpan);
      row.appendChild(body);
      epgListEl.appendChild(row);
    });
  }

  function parseXmltvDate(str) {
    if (!str) return null;
    const m = str.match(/^(\d{14})(?:\s+([+-]\d{4}))?/);
    if (!m) return null;
    const base = m[1];
    const tz   = m[2] || "+0000";
    const Y    = base.slice(0,4);
    const M    = base.slice(4,6);
    const D    = base.slice(6,8);
    const h    = base.slice(8,10);
    const mi   = base.slice(10,12);
    const s    = base.slice(12,14);
    const offsetH = parseInt(tz.slice(1,3),10);
    const offsetM = parseInt(tz.slice(3,5),10);
    const sign    = tz[0] === "-" ? -1 : 1;
    const dateStr = `${Y}-${M}-${D}T${h}:${mi}:${s}Z`;
    const utcMs   = Date.parse(dateStr);
    if (isNaN(utcMs)) return null;
    const localMs = utcMs - sign * (offsetH * 60 + offsetM) * 60 * 1000;
    return localMs;
  }

  function formatTime(ms) {
    const d = new Date(ms);
    return d.toLocaleTimeString("sv-SE", { hour: "2-digit", minute: "2-digit" });
  }

  function formatEpgTime(start, end) {
    const s = (start || "").toString();
    const e = (end || "").toString();
    const sTime = s.split(" ")[1]?.substring(0,5) || "";
    const eTime = e.split(" ")[1]?.substring(0,5) || "";
    if (sTime && eTime) return sTime + " ‚Äì " + eTime;
    return s || "";
  }

  // --- events ---

  loginBtn.addEventListener("click", () => {
    state.username = (usernameInput.value || "").trim();
    state.password = (passwordInput.value || "").trim();
    state.m3uUrl   = (m3uInput.value || "").trim();
    state.epgUrl   = (epgInput.value || "").trim();

    if (!state.username && !state.m3uUrl) {
      alert("Fyll i minst Xtream (anv√§ndare/l√∂sen) eller en M3U-l√§nk.");
      return;
    }

    connect().catch(err => {
      console.error(err);
      alert("Ett fel uppstod: " + err.message);
    });
  });

  serverInput.value = LIVEGO_SERVER;
  portalLabel.textContent = "Portal: " + LIVEGO_SERVER.replace(/^https?:\/\//,"");

  topbarNav.querySelectorAll("span").forEach(span => {
    span.addEventListener("click", () => {
      topbarNav.querySelectorAll("span").forEach(s => s.classList.remove("active"));
      span.classList.add("active");
      state.currentView = span.dataset.view;
      state.currentCategory = null;
      updateSidebarCategories();
      onViewChanged();
    });
  });

  viewChipEl.querySelectorAll("span").forEach(span => {
    span.addEventListener("click", () => {
      viewChipEl.querySelectorAll("span").forEach(s => s.classList.remove("active"));
      span.classList.add("active");
      state.viewMode = span.dataset.viewchip || "grid";
      onViewChanged();
    });
  });

  searchInput.addEventListener("input", () => {
    onViewChanged();
  });

  filterChips.forEach(chip => {
    chip.addEventListener("click", () => {
      filterChips.forEach(c => c.classList.remove("active"));
      chip.classList.add("active");
      onViewChanged();
    });
  });

  refreshBtn.addEventListener("click", () => {
    if (!state.username && !state.m3uUrl) {
      alert("Inlogga f√∂rst innan du uppdaterar.");
      return;
    }
    log("Uppdaterar data...");
    connect().catch(err => {
      console.error(err);
      alert("Ett fel uppstod vid uppdatering: " + err.message);
    });
  });
</script>
</body>
</html>
